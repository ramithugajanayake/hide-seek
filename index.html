<!DOCTYPE html>
<html>
<head>
  <title>Hide & Seek Demo</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map {
      height: 90vh;
      width: 100%;
    }
    body { margin: 0; padding: 0; }
  </style>
</head>
<body>
  <h2 style="text-align:center;">Hide & Seek Demo Map</h2>
  <div id="map"></div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

    // Replace with your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD259A37SrWNP8jaRP7h3NLKQMIAsr5jC4",
      authDomain: "hide-seek-demo-f6c65.firebaseapp.com",
      databaseURL: "https://hide-seek-demo-default-rtdb.firebaseio.com",
      projectId: "hide-seek-demo-f6c65",
      storageBucket: "hide-seek-demo-f6c65.firebasestorage.app",
      messagingSenderId: "457844478016",
      appId: "1:457844478016:web:7e576a496bea1fe03d8fa5"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Unique player ID (for demo, use random number)
    const playerId = "player_" + Math.floor(Math.random() * 10000);

    // Store markers of all players
    const playerMarkers = {};
  </script>

  <!-- Leaflet Map -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Map + Geolocation + Multiplayer -->
  <script type="module">
    import { ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
    import { getDatabase } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

    const map = L.map('map').setView([6.033, 80.216], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    let marker;

    // Function to update your location
    function updateLocation(position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;

      // Update your marker
      if (!marker) {
        marker = L.marker([lat, lon], {title: "You"}).addTo(map).bindPopup("You are here").openPopup();
      } else {
        marker.setLatLng([lat, lon]);
      }

      map.setView([lat, lon], 18);

      // Write your location to Firebase
      set(ref(database, 'players/' + playerId), {
        lat: lat,
        lon: lon,
        lastUpdate: Date.now()
      });
    }

    function locationError(err) {
      alert("Error getting location: " + err.message);
    }

    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(updateLocation, locationError, { enableHighAccuracy: true });
    } else {
      alert("Geolocation is not supported by your browser.");
    }

    // Listen to all players in Firebase
    const playersRef = ref(database, 'players');
    onValue(playersRef, (snapshot) => {
      const players = snapshot.val() || {};

      for (let id in players) {
        if (id === playerId) continue; // skip yourself

        const player = players[id];
        if (!playerMarkers[id]) {
          // Add marker for new player
          playerMarkers[id] = L.marker([player.lat, player.lon], {title: id}).addTo(map).bindPopup(id);
        } else {
          // Update existing marker
          playerMarkers[id].setLatLng([player.lat, player.lon]);
        }
      }

      // Remove markers of players who left
      for (let id in playerMarkers) {
        if (!players[id]) {
          map.removeLayer(playerMarkers[id]);
          delete playerMarkers[id];
        }
      }
    });
  </script>
</body>
</html>
